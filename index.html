<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONäººç‰©å±æ€§ç¼–è¾‘å™¨</title>
    <style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1000px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

header {
    background: #2c3e50;
    color: white;
    padding: 25px;
    text-align: center;
}

h1 {
    font-size: 2rem;
    margin-bottom: 10px;
}

.description {
    font-size: 1.1rem;
    opacity: 0.9;
}

.main-content {
    padding: 25px;
}

.file-input-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 25px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px dashed #dee2e6;
}

.file-input-label {
    display: inline-block;
    padding: 12px 25px;
    background-color: #3498db;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    margin-bottom: 10px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.file-input-label:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

#fileInput {
    display: none;
}

.file-name {
    font-size: 1rem;
    color: #6c757d;
    margin-top: 5px;
}

.selector-section {
    margin-bottom: 25px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.selector-label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: #2c3e50;
}

.person-selector {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 1rem;
    background-color: white;
    cursor: pointer;
    transition: border-color 0.3s;
}

.person-selector:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.editor-section {
    margin-bottom: 25px;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.section-heading {
    background: #3498db;
    color: white;
    padding: 15px 20px;
    font-size: 1.3rem;
    font-weight: 600;
}

.properties-container {
    padding: 20px;
}

.property-group {
    margin-bottom: 20px;
}

.property-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
}

.property-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    transition: border-color 0.3s;
}

.property-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

textarea.property-input {
    min-height: 180px;
    resize: vertical;
    font-family: 'Courier New', monospace;
}

.button-section {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 30px;
}

button {
    padding: 12px 30px;
    border: none;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    min-width: 140px;
}

#saveButton {
    background-color: #2ecc71;
    color: white;
    box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
}

#saveButton:hover:not(:disabled) {
    background-color: #27ae60;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(46, 204, 113, 0.4);
}

#resetButton {
    background-color: #e74c3c;
    color: white;
    box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
}

#resetButton:hover {
    background-color: #c0392b;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(231, 76, 60, 0.4);
}

button:disabled {
    background-color: #bdc3c7;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.status-message {
    text-align: center;
    margin-top: 20px;
    padding: 15px;
    border-radius: 5px;
    display: none;
    font-weight: 500;
}

.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    .container {
        border-radius: 8px;
    }

    header {
        padding: 20px 15px;
    }

    h1 {
        font-size: 1.6rem;
    }

    .main-content {
        padding: 15px;
    }

    .button-section {
        flex-direction: column;
    }

    button {
        width: 100%;
    }
}

@media (min-width: 992px) {
    .properties-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
}

.diary-actions {
    display: flex;
    gap: 10px;
    margin: -10px 0 20px;
    flex-wrap: wrap;
}

#addDiaryButton {
    background-color: #8e44ad;
    color: #fff;
}

#addDiaryButton:hover:not(:disabled) {
    background-color: #7d3c98;
}

#deleteDiaryButton {
    background-color: #d35400;
    color: #fff;
}

#deleteDiaryButton:hover:not(:disabled) {
    background-color: #ba4a00;
}

.property-input-large {
    min-height: 260px;
}


@media (max-width: 768px) {
    .diary-actions {
        flex-direction: column;
    }

    .diary-actions button,
    .button-section button {
        width: 100%;
    }

    textarea.property-input {
        min-height: 240px;
    }

    .property-input-large {
        min-height: 320px;
    }
}

    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>å¦¹å±…å­˜æ¡£ç¼–è¾‘å™¨</h1>
            <p class="description">é€‰æ‹©å­˜æ¡£æ–‡ä»¶åï¼Œå³å¯ç¼–è¾‘ç›¸åº”äººè®¾ä¿¡æ¯</p>
        </header>

        <div class="main-content">
            <div class="file-input-section">
                <label for="fileInput" class="file-input-label">é€‰æ‹©JSONå­˜æ¡£æ–‡ä»¶</label>
                <div class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
            <input type="file" id="fileInput" accept="application/json">

            <div class="selector-section" id="selectorSection" style="display: none;">
                <label for="personSelector" class="selector-label">é€‰æ‹©ç¼–è¾‘åˆ†åŒºï¼š</label>
                <select id="personSelector" class="person-selector">
                    <option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªåˆ†åŒº --</option>
                </select>
            </div>

            <div class="diary-actions" id="diaryActions" style="display: none;">
                <button id="addDiaryButton" type="button">æ–°å¢æ—¥è®°</button>
                <button id="deleteDiaryButton" type="button" disabled>åˆ é™¤å½“å‰æ—¥è®°</button>
            </div>

            <div id="editorContainer">
                <div class="empty-state" id="emptyState">
                    <div>ğŸ“</div>
                    <p>è¯·é€‰æ‹©ä¸€ä¸ªJSONå­˜æ¡£æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
                </div>

                <div class="editor-sections" id="editorSections">
                    <div class="editor-section" id="editorSection" style="display: none;">
                        <div class="section-heading" id="sectionHeading">äººç‰©å±æ€§</div>
                        <div class="properties-container" id="propertiesContainer">
                            <!-- å±æ€§ç¼–è¾‘åŒºåŸŸå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-section">
                <button id="saveButton" disabled>ä¿å­˜æ–‡ä»¶</button>
                <button id="resetButton" disabled>é‡ç½®å†…å®¹</button>
            </div>

            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const translation = new Map([
                ['sister-dilei', 'åœ°é›·å¦¹'],
                ['sister-high', 'é«˜å¥½æ„Ÿåº¦(70+)'],
                ['sister-low', 'ä½å¥½æ„Ÿåº¦(-30~30)'],
                ['sister-medium', 'æ™®é€šå¥½æ„Ÿåº¦(30~70)'],
                ['sister-null', 'ç—…å¨‡'],
                ['sister-verylow', 'æ¯’èˆŒ'],
                ['playerInfo', 'ç©å®¶ä¿¡æ¯'],
                ['characterStats', 'è§’è‰²æ•°å€¼'],
                ['stats', 'ä¿¡èµ–/å¥½æ„Ÿæ•°å€¼'],
                ['playerProgress', 'ç©å®¶è¿›åº¦'],
                ['timeSystem', 'æ—¶é—´ç³»ç»Ÿ'],
                ['settings', 'æ¸¸æˆè®¾ç½®'],
                ['globalLevelSystem', 'å…¨å±€ç­‰çº§'],
                ['name', 'å§“å'],
                ['description', 'æè¿°'],
                ['personality', 'æ€§æ ¼'],
                ['first_mes', 'åˆæ¬¡å¯¹è¯'],
                ['mes_example', 'å¯¹è¯ç¤ºä¾‹'],
                ['scenario', 'åœºæ™¯'],
                ['creator_notes', 'åˆ›ä½œè€…å¤‡æ³¨'],
                ['tags', 'æ ‡ç­¾'],
                ['timestamp', 'æ—¶é—´æˆ³'],
                ['date', 'æ—¥æœŸ'],
                ['time', 'æ—¶é—´'],
                ['affection', 'å¥½æ„Ÿ'],
                ['trust', 'ä¿¡èµ–'],
                ['content', 'å†…å®¹'],
                ['mode', 'æ¨¡å¼']
            ]);

            const fileInput = document.getElementById('fileInput');
            const fileNameDisplay = document.getElementById('fileName');
            const personSelector = document.getElementById('personSelector');
            const editorSections = document.getElementById('editorSections');
            const selectorSection = document.getElementById('selectorSection');
            const diaryActions = document.getElementById('diaryActions');
            const addDiaryButton = document.getElementById('addDiaryButton');
            const deleteDiaryButton = document.getElementById('deleteDiaryButton');
            const emptyState = document.getElementById('emptyState');
            const saveButton = document.getElementById('saveButton');
            const resetButton = document.getElementById('resetButton');

            const editorSection = {};
            let saveObj = null;
            let saveObjOriginal = null;

            function showStatusMessage(message, type) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.textContent = message;
                statusMessage.className = 'status-message ' + type;
                statusMessage.style.display = 'block';
                if (type === 'success') {
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 3000);
                }
            }

            function clearEditorState() {
                Object.keys(editorSection).forEach(key => delete editorSection[key]);
                editorSections.innerHTML = '';
                personSelector.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªåˆ†åŒº --</option>';
                selectorSection.style.display = 'none';
                diaryActions.style.display = 'none';
                deleteDiaryButton.disabled = true;
            }

            function getType(value) {
                if (Array.isArray(value)) return 'array';
                if (value === null) return 'null';
                return typeof value;
            }

            function parseValue(rawValue, type, parserMode) {
                if (parserMode === 'stringArrayByLine') {
                    return rawValue
                        .split('\n')
                        .map(item => item.trim())
                        .filter(Boolean);
                }
                if (type === 'number') {
                    const parsed = Number(rawValue);
                    if (Number.isNaN(parsed)) throw new Error('æ•°å­—å­—æ®µå¡«å†™æ— æ•ˆ: ' + rawValue);
                    return parsed;
                }
                if (type === 'boolean') {
                    const lower = rawValue.trim().toLowerCase();
                    if (lower === 'true') return true;
                    if (lower === 'false') return false;
                    throw new Error('å¸ƒå°”å­—æ®µè¯·å¡«å†™ true æˆ– false');
                }
                if (type === 'null') {
                    return rawValue.trim().toLowerCase() === 'null' || rawValue.trim() === '' ? null : rawValue;
                }
                if (type === 'object' || type === 'array') {
                    return JSON.parse(rawValue);
                }
                return rawValue;
            }

            function setValueByPath(obj, path, value) {
                let target = obj;
                for (let i = 0; i < path.length - 1; i++) {
                    target = target[path[i]];
                }
                target[path[path.length - 1]] = value;
            }

            function syncInputsToSaveObj() {
                Object.keys(editorSection).forEach(sectionKey => {
                    const section = editorSection[sectionKey];
                    Object.keys(section.propertyInputs).forEach(attr => {
                        const rawValue = section.propertyInputs[attr].value;
                        const meta = section.fieldMeta[attr];
                        const parsedValue = parseValue(rawValue, meta.type, meta.parserMode);
                        setValueByPath(saveObj, meta.path, parsedValue);
                    });
                });
            }

            function toTimeValue(entry) {
                if (!entry || typeof entry !== 'object') return Number.MAX_SAFE_INTEGER;
                const ts = entry.timestamp;
                if (typeof ts === 'number' && Number.isFinite(ts)) return ts;
                if (typeof ts === 'string') {
                    const parsed = Date.parse(ts);
                    if (!Number.isNaN(parsed)) return parsed;
                }
                const date = typeof entry.date === 'string' ? entry.date.replace(/\//g, '-') : '';
                const time = typeof entry.time === 'string' ? entry.time : '';
                if (date) {
                    const parsed = Date.parse(`${date} ${time}`.trim());
                    if (!Number.isNaN(parsed)) return parsed;
                }
                return Number.MAX_SAFE_INTEGER;
            }

            function sortDiaryByTime() {
                const diaryList = saveObj?.data?.diary;
                if (!Array.isArray(diaryList)) return;
                diaryList.sort((a, b) => toTimeValue(a) - toTimeValue(b));
            }

            function createEditorSection(sectionKey, sectionTitle, sourceObj, basePath) {
                const option = document.createElement('option');
                option.value = sectionKey;
                option.textContent = sectionTitle;
                personSelector.appendChild(option);

                editorSection[sectionKey] = { propertyInputs: {}, fieldMeta: {} };

                const mainContainer = document.createElement('div');
                mainContainer.className = 'editor-section';
                mainContainer.style.display = 'none';
                editorSection[sectionKey].mainContainer = mainContainer;
                editorSections.appendChild(mainContainer);

                const sectionHeading = document.createElement('div');
                sectionHeading.className = 'section-heading';
                sectionHeading.textContent = sectionTitle;
                mainContainer.appendChild(sectionHeading);

                const propertiesContainer = document.createElement('div');
                propertiesContainer.className = 'properties-container';
                mainContainer.appendChild(propertiesContainer);

                Object.keys(sourceObj).forEach(attr => {
                    const propertyGroup = document.createElement('div');
                    propertyGroup.className = 'property-group';
                    propertiesContainer.appendChild(propertyGroup);

                    const propertyInput = document.createElement('textarea');
                    propertyInput.className = 'property-input';
                    propertyInput.id = `${sectionKey}-${attr}`;

                    const originalValue = sourceObj[attr];
                    const valueType = getType(originalValue);
                    let parserMode = 'default';

                    if (attr === 'tags' && Array.isArray(originalValue) && originalValue.every(item => typeof item === 'string')) {
                        parserMode = 'stringArrayByLine';
                        propertyInput.value = originalValue.join('\n');
                        propertyInput.placeholder = 'æ¯è¡Œä¸€ä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š\nå¥³ç”Ÿ\næ ¡å›­\nå¦¹å¦¹';
                    } else {
                        propertyInput.value = valueType === 'object' || valueType === 'array'
                            ? JSON.stringify(originalValue, null, 2)
                            : String(originalValue ?? '');
                    }

                    if (attr === 'content') {
                        propertyInput.classList.add('property-input-large');
                    }

                    const propertyLabel = document.createElement('label');
                    propertyLabel.className = 'property-label';
                    propertyLabel.htmlFor = propertyInput.id;
                    propertyLabel.textContent = parserMode === 'stringArrayByLine'
                        ? `${translation.get(attr) || attr} (æ¯è¡Œä¸€ä¸ª)`
                        : `${translation.get(attr) || attr} (${valueType})`;

                    propertyGroup.appendChild(propertyLabel);
                    propertyGroup.appendChild(propertyInput);

                    editorSection[sectionKey].propertyInputs[attr] = propertyInput;
                    editorSection[sectionKey].fieldMeta[attr] = { path: [...basePath, attr], type: valueType, parserMode };
                });
            }

            function addSectionGroupLabel(text) {
                const groupLabel = document.createElement('option');
                groupLabel.disabled = true;
                groupLabel.textContent = `â”€â”€â”€â”€â”€â”€â”€â”€ ${text} â”€â”€â”€â”€â”€â”€â”€â”€`;
                personSelector.appendChild(groupLabel);
            }

            function createBaseSection(targetSaveObj) {
                const gameData = targetSaveObj?.data?.gameData;
                if (!gameData || typeof gameData !== 'object') return;

                addSectionGroupLabel('åŸºç¡€å‚æ•°');
                const baseTargets = [
                    { key: 'playerInfo', path: ['data', 'gameData', 'playerInfo'] },
                    { key: 'characterStats', path: ['data', 'gameData', 'characterStats'] },
                    { key: 'stats', path: ['data', 'gameData', 'characterSystemData', 'stats'] },
                    { key: 'playerProgress', path: ['data', 'gameData', 'playerProgress'] },
                    { key: 'globalLevelSystem', path: ['data', 'gameData', 'globalLevelSystem'] },
                    { key: 'timeSystem', path: ['data', 'gameData', 'timeSystem'] },
                    { key: 'settings', path: ['data', 'gameData', 'settings'] }
                ];

                baseTargets.forEach(item => {
                    const sectionObj = item.path.reduce((acc, seg) => (acc ? acc[seg] : null), targetSaveObj);
                    if (sectionObj && typeof sectionObj === 'object') {
                        createEditorSection(`base:${item.key}`, translation.get(item.key) || item.key, sectionObj, item.path);
                    }
                });
            }

            function populateSelectorsAndEditors(targetSaveObj) {
                clearEditorState();
                createBaseSection(targetSaveObj);

                const prompts = targetSaveObj?.data?.prompts;
                if (prompts && typeof prompts === 'object') {
                    addSectionGroupLabel('äººè®¾');
                    Object.keys(prompts).forEach(promptKey => {
                        const promptData = prompts[promptKey]?.data;
                        if (promptData && typeof promptData === 'object') {
                            createEditorSection(`prompt:${promptKey}`, translation.get(promptKey) || promptKey, promptData, ['data', 'prompts', promptKey, 'data']);
                        }
                    });
                }

                sortDiaryByTime();
                const diaryList = targetSaveObj?.data?.diary;
                if (Array.isArray(diaryList)) {
                    addSectionGroupLabel('æ—¥è®°');
                    diaryList.forEach((entry, index) => {
                        if (!entry || typeof entry !== 'object') return;
                        const diaryTitle = entry.date ? `æ—¥è®° #${index + 1} (${entry.date} ${entry.time || ''})` : `æ—¥è®° #${index + 1}`;
                        createEditorSection(`diary:${index}`, diaryTitle, entry, ['data', 'diary', index]);
                    });
                }

                const hasSections = Object.keys(editorSection).length > 0;
                selectorSection.style.display = hasSections ? 'block' : 'none';
                diaryActions.style.display = hasSections ? 'flex' : 'none';
            }

            function updateDiaryButtonState() {
                deleteDiaryButton.disabled = !personSelector.value.startsWith('diary:');
            }

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                fileNameDisplay.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        saveObj = JSON.parse(e.target.result);
                        saveObjOriginal = JSON.parse(e.target.result);
                        populateSelectorsAndEditors(saveObj);
                        emptyState.style.display = 'none';
                        saveButton.disabled = false;
                        resetButton.disabled = false;
                        showStatusMessage('æ–‡ä»¶è¯»å–æˆåŠŸ', 'success');
                    } catch (error) {
                        showStatusMessage('JSONæ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message, 'error');
                    }
                };
                reader.onerror = () => showStatusMessage('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™', 'error');
                reader.readAsText(file);
            });

            personSelector.addEventListener('change', () => {
                Object.keys(editorSection).forEach(key => {
                    editorSection[key].mainContainer.style.display = key === personSelector.value ? 'block' : 'none';
                });
                updateDiaryButtonState();
            });

            addDiaryButton.addEventListener('click', () => {
                if (!saveObj) {
                    showStatusMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }

                try {
                    syncInputsToSaveObj();

                    if (!Array.isArray(saveObj?.data?.diary)) {
                        saveObj.data.diary = [];
                    }

                    const now = new Date();
                    const newDiary = {
                        timestamp: now.toISOString(),
                        date: `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`,
                        time: now.toTimeString().slice(0, 8),
                        affection: 0,
                        content: 'è¯·è¾“å…¥æ—¥è®°å†…å®¹',
                        mode: 'Custom'
                    };
                    saveObj.data.diary.push(newDiary);
                    sortDiaryByTime();
                    populateSelectorsAndEditors(saveObj);
                    const newIndex = saveObj.data.diary.findIndex(item => item === newDiary);
                    personSelector.value = `diary:${newIndex}`;
                    personSelector.dispatchEvent(new Event('change'));
                    showStatusMessage('å·²æ–°å¢æ—¥è®°', 'success');
                } catch (error) {
                    showStatusMessage('æ–°å¢æ—¥è®°å‰æœ‰æœªä¿å­˜çš„æ— æ•ˆå­—æ®µ: ' + error.message, 'error');
                }
            });

            deleteDiaryButton.addEventListener('click', () => {
                if (!saveObj || !personSelector.value.startsWith('diary:')) {
                    showStatusMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ—¥è®°', 'error');
                    return;
                }

                try {
                    syncInputsToSaveObj();

                    const index = Number(personSelector.value.split(':')[1]);
                    const diaryList = saveObj?.data?.diary;
                    if (!Array.isArray(diaryList) || Number.isNaN(index) || !diaryList[index]) {
                        showStatusMessage('åˆ é™¤å¤±è´¥ï¼šæœªæ‰¾åˆ°è¯¥æ—¥è®°', 'error');
                        return;
                    }
                    diaryList.splice(index, 1);
                    sortDiaryByTime();
                    populateSelectorsAndEditors(saveObj);
                    personSelector.value = '';
                    showStatusMessage('å·²åˆ é™¤æ—¥è®°', 'success');
                } catch (error) {
                    showStatusMessage('åˆ é™¤æ—¥è®°å‰æœ‰æœªä¿å­˜çš„æ— æ•ˆå­—æ®µ: ' + error.message, 'error');
                }
            });

            saveButton.addEventListener('click', () => {
                if (!saveObj) {
                    showStatusMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }

                try {
                    syncInputsToSaveObj();

                    sortDiaryByTime();

                    const content = JSON.stringify(saveObj, null, 2);
                    const blob = new Blob([content], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const originalName = fileNameDisplay.textContent;
                    const dotIndex = originalName.lastIndexOf('.');
                    const newName = dotIndex > 0
                        ? originalName.substring(0, dotIndex) + '_edited' + originalName.substring(dotIndex)
                        : originalName + '_edited';
                    a.download = newName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    populateSelectorsAndEditors(saveObj);
                    personSelector.value = '';
                    showStatusMessage('æ–‡ä»¶ä¿å­˜æˆåŠŸï¼', 'success');
                } catch (error) {
                    showStatusMessage('ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message, 'error');
                }
            });

            resetButton.addEventListener('click', () => {
                if (!saveObjOriginal) {
                    showStatusMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }
                saveObj = JSON.parse(JSON.stringify(saveObjOriginal));
                populateSelectorsAndEditors(saveObj);
                personSelector.value = '';
                showStatusMessage('å†…å®¹å·²é‡ç½®ä¸ºåŸå§‹æ–‡ä»¶', 'success');
            });
        });
    </script>
</body>

</html>