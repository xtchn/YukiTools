<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONäººç‰©å±æ€§ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" type="text/css" href="main.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>å¦¹å±…å­˜æ¡£ç¼–è¾‘å™¨</h1>
            <p class="description">é€‰æ‹©å­˜æ¡£æ–‡ä»¶åï¼Œå³å¯ç¼–è¾‘ç›¸åº”äººè®¾ä¿¡æ¯</p>
        </header>

        <div class="main-content">
            <div class="file-input-section">
                <label for="fileInput" class="file-input-label">é€‰æ‹©JSONå­˜æ¡£æ–‡ä»¶</label>
                <div class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
            <input type="file" id="fileInput" accept="application/json">

            <div class="selector-section" id="selectorSection" style="display: none;">
                <label for="personSelector" class="selector-label">é€‰æ‹©äººè®¾ï¼š</label>
                <select id="personSelector" class="person-selector">
                    <option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾ --</option>
                </select>
            </div>

            <div id="editorContainer">
                <div class="empty-state" id="emptyState">
                    <div>ğŸ“</div>
                    <p>è¯·é€‰æ‹©ä¸€ä¸ªJSONå­˜æ¡£æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
                </div>

                <div class="editor-sections" id="editorSections">
                    <div class="editor-section" id="editorSection" style="display: none;">
                        <div class="section-heading" id="sectionHeading">äººç‰©å±æ€§</div>
                        <div class="properties-container" id="propertiesContainer">
                            <!-- å±æ€§ç¼–è¾‘åŒºåŸŸå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-section">
                <button id="saveButton" disabled>ä¿å­˜æ–‡ä»¶</button>
                <button id="resetButton" disabled>é‡ç½®å†…å®¹</button>
            </div>

            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const translation = new Map([
                ['sister-dilei', 'åœ°é›·å¦¹'],
                ['sister-high', 'é«˜å¥½æ„Ÿåº¦(70+)'],
                ['sister-low', 'ä½å¥½æ„Ÿåº¦(-30~30)'],
                ['sister-medium', 'æ™®é€šå¥½æ„Ÿåº¦(30~70)'],
                ['sister-null', 'ç—…å¨‡'],
                ['sister-verylow', 'æ¯’èˆŒ'],

                ['name', 'å§“å'],
                ['description', 'æè¿°'],
                ['personality', 'æ€§æ ¼'],
                ['first_mes', 'åˆæ¬¡å¯¹è¯'],
                ['mes_example', 'å¯¹è¯ç¤ºä¾‹'],
                ['scenario', 'åœºæ™¯'],
                ['creator_notes', 'åˆ›ä½œè€…å¤‡æ³¨'],
                ['tags', 'æ ‡ç­¾'],
                ['timestamp', 'æ—¶é—´æˆ³'],
                ['date', 'æ—¥æœŸ'],
                ['time', 'æ—¶é—´'],
                ['affection', 'å¥½æ„Ÿ'],
                ['content', 'å†…å®¹'],
                ['mode', 'æ¨¡å¼']
            ]);

            const fileInput = document.getElementById('fileInput');
            const fileNameDisplay = document.getElementById('fileName');
            const personSelector = document.getElementById('personSelector');
            const editorSections = document.getElementById('editorSections');
            const selectorSection = document.getElementById('selectorSection');
            const emptyState = document.getElementById('emptyState');
            const saveButton = document.getElementById('saveButton');
            const resetButton = document.getElementById('resetButton');

            const editorSection = {};
            let saveObj = null;
            let saveObjOriginal = null;

            function showStatusMessage(message, type) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.textContent = message;
                statusMessage.className = 'status-message ' + type;
                statusMessage.style.display = 'block';
                if (type === 'success') {
                    setTimeout(hideStatusMessage, 3000);
                }
            }

            function hideStatusMessage() {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.style.display = 'none';
            }

            function clearEditorState() {
                Object.keys(editorSection).forEach(key => delete editorSection[key]);
                editorSections.innerHTML = '';
                personSelector.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾è¿›è¡Œç¼–è¾‘ --</option>';
                selectorSection.style.display = 'none';
            }

            function getType(value) {
                if (Array.isArray(value)) return 'array';
                if (value === null) return 'null';
                return typeof value;
            }

            function parseValue(rawValue, type) {
                if (type === 'number') {
                    const parsed = Number(rawValue);
                    if (Number.isNaN(parsed)) {
                        throw new Error('æ•°å­—å­—æ®µå¡«å†™æ— æ•ˆ: ' + rawValue);
                    }
                    return parsed;
                }
                if (type === 'boolean') {
                    const lower = rawValue.trim().toLowerCase();
                    if (lower === 'true') return true;
                    if (lower === 'false') return false;
                    throw new Error('å¸ƒå°”å­—æ®µè¯·å¡«å†™ true æˆ– false');
                }
                if (type === 'null') {
                    return null;
                }
                if (type === 'object' || type === 'array') {
                    return JSON.parse(rawValue);
                }
                return rawValue;
            }

            function setValueByPath(obj, path, value) {
                let target = obj;
                for (let i = 0; i < path.length - 1; i++) {
                    target = target[path[i]];
                }
                target[path[path.length - 1]] = value;
            }

            function createEditorSection(sectionKey, sectionTitle, sourceObj, basePath) {
                const option = document.createElement('option');
                option.value = sectionKey;
                option.textContent = sectionTitle;
                personSelector.appendChild(option);

                editorSection[sectionKey] = {
                    propertyInputs: {},
                    fieldMeta: {}
                };

                const mainContainer = document.createElement('div');
                mainContainer.className = 'editor-section';
                mainContainer.style.display = 'none';
                editorSection[sectionKey].mainContainer = mainContainer;
                editorSections.appendChild(mainContainer);

                const sectionHeading = document.createElement('div');
                sectionHeading.className = 'section-heading';
                sectionHeading.textContent = sectionTitle;
                mainContainer.appendChild(sectionHeading);

                const propertiesContainer = document.createElement('div');
                propertiesContainer.className = 'properties-container';
                mainContainer.appendChild(propertiesContainer);

                Object.keys(sourceObj).forEach(attr => {
                    const propertyGroup = document.createElement('div');
                    propertyGroup.className = 'property-group';
                    propertiesContainer.appendChild(propertyGroup);

                    const propertyInput = document.createElement('textarea');
                    propertyInput.className = 'property-input';
                    propertyInput.id = `${sectionKey}-${attr}`;

                    const originalValue = sourceObj[attr];
                    const valueType = getType(originalValue);
                    propertyInput.value = valueType === 'object' || valueType === 'array'
                        ? JSON.stringify(originalValue, null, 2)
                        : String(originalValue ?? '');

                    const propertyLabel = document.createElement('label');
                    propertyLabel.className = 'property-label';
                    propertyLabel.htmlFor = propertyInput.id;
                    propertyLabel.textContent = `${translation.get(attr) || attr} (${valueType})`;

                    propertyGroup.appendChild(propertyLabel);
                    propertyGroup.appendChild(propertyInput);

                    editorSection[sectionKey].propertyInputs[attr] = propertyInput;
                    editorSection[sectionKey].fieldMeta[attr] = {
                        path: [...basePath, attr],
                        type: valueType
                    };
                });
            }

            function populateSelectorsAndEditors(targetSaveObj) {
                clearEditorState();

                const prompts = targetSaveObj?.data?.prompts;
                if (prompts && typeof prompts === 'object') {
                    Object.keys(prompts).forEach(promptKey => {
                        const promptData = prompts[promptKey]?.data;
                        if (promptData && typeof promptData === 'object') {
                            createEditorSection(
                                `prompt:${promptKey}`,
                                translation.get(promptKey) || promptKey,
                                promptData,
                                ['data', 'prompts', promptKey, 'data']
                            );
                        }
                    });
                }

                const diaryList = targetSaveObj?.data?.diary;
                if (Array.isArray(diaryList)) {
                    diaryList.forEach((entry, index) => {
                        if (!entry || typeof entry !== 'object') return;
                        const diaryTitle = entry.date ? `æ—¥è®° #${index + 1} (${entry.date})` : `æ—¥è®° #${index + 1}`;
                        createEditorSection(
                            `diary:${index}`,
                            diaryTitle,
                            entry,
                            ['data', 'diary', index]
                        );
                    });
                }

                selectorSection.style.display = Object.keys(editorSection).length > 0 ? 'block' : 'none';
            }

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                fileNameDisplay.textContent = file.name;
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        saveObj = JSON.parse(e.target.result);
                        saveObjOriginal = JSON.parse(e.target.result);
                        populateSelectorsAndEditors(saveObj);

                        emptyState.style.display = 'none';
                        saveButton.disabled = false;
                        resetButton.disabled = false;
                        showStatusMessage('æ–‡ä»¶è¯»å–æˆåŠŸ', 'success');
                    } catch (error) {
                        showStatusMessage('JSONæ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message, 'error');
                        console.error(error);
                    }
                };

                reader.onerror = () => showStatusMessage('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™', 'error');
                reader.readAsText(file);
            });

            personSelector.addEventListener('change', () => {
                Object.keys(editorSection).forEach(key => {
                    editorSection[key].mainContainer.style.display = key === personSelector.value ? 'block' : 'none';
                });
            });

            saveButton.addEventListener('click', () => {
                if (!saveObj) {
                    showStatusMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }

                try {
                    Object.keys(editorSection).forEach(sectionKey => {
                        const section = editorSection[sectionKey];
                        Object.keys(section.propertyInputs).forEach(attr => {
                            const rawValue = section.propertyInputs[attr].value;
                            const meta = section.fieldMeta[attr];
                            const parsedValue = parseValue(rawValue, meta.type);
                            setValueByPath(saveObj, meta.path, parsedValue);
                        });
                    });

                    const content = JSON.stringify(saveObj, null, 2);
                    const blob = new Blob([content], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    const originalName = fileNameDisplay.textContent;
                    const dotIndex = originalName.lastIndexOf('.');
                    const newName = dotIndex > 0
                        ? originalName.substring(0, dotIndex) + '_edited' + originalName.substring(dotIndex)
                        : originalName + '_edited';

                    a.download = newName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showStatusMessage('æ–‡ä»¶ä¿å­˜æˆåŠŸï¼', 'success');
                } catch (error) {
                    showStatusMessage('ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message, 'error');
                }
            });

            resetButton.addEventListener('click', () => {
                if (!saveObjOriginal) {
                    showStatusMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }

                saveObj = JSON.parse(JSON.stringify(saveObjOriginal));
                populateSelectorsAndEditors(saveObj);
                personSelector.value = '';
                showStatusMessage('å†…å®¹å·²é‡ç½®ä¸ºåŸå§‹æ–‡ä»¶', 'success');
            });
        });
    </script>
</body>

</html>